#------------------------------------------------------------------#
#                                                                  #
# (C) Copyright IBM Corp.  2008, 2008                              #
# IBM CPL License                                                  #
#                                                                  #
#------------------------------------------------------------------#



.PHONY: default all install clean distclean subdirs $(SUBDIRS) runjob runmmcslite bgqrun 

default:	all $(TEST_INSTALL_DIR)/$(TARGET)

$(TEST_INSTALL_DIR)/$(TARGET): $(TARGET)
	$(call bgq_install_bin,$<,$@)


install:	all  $(TEST_INSTALL_DIR)/$(TARGET)
	@echo "Installing $(CURDIRNAME)"


all:	subdirs $(TARGET)


$(TARGET): $(TEST_OBJS) $(LOCAL_LIBS)

#
# library subdirectoreis
# 
subdirs:  $(SUBDIRS)

$(SUBDIRS):
	$(MAKE) --directory $@

clean::
	@echo "Cleaning $(CURDIRNAME)/"
	-$(RM_F) *.o *.listing *.map *.objdump *.nm *.readelf *.elf *.bin .dep*


distclean: clean
	@echo "Dist-cleaning $(CURDIRNAME)"
	@-rm -rf $(TEST_INSTALL_DIR)
	@-$(RM_F) ./Make.depend


depend::
	@echo "Making dependencies for $(CURDIRNAME)"
	@-$(RM_F) ./Make.depend
	@$(BGQ_CROSS_CC) -MM  $(K_CPU_FLAGS) $(K_KFLAGS) $(K_CPPFLAGS) $(C_SRC)    > ./Make.depend


fresh:	clean depend install

#
# script for local self testing
# Run a firmware extension on mesa
runmmcslite: install
	$(RUNTEST) mmcslite --block=$(block) --prog=$(TESTNAME).elf --args=$(PROG_ARGS) --ppn=$(JOB_PPN) --jobparms="$(parms)"


runmesahelp:
	$(BGQ_INSTALL_DIR)/scripts/runfctest.sh --help


runjob:
	$(RUNTEST) runjob --block=$(block) --prog=$(TESTNAME).elf --args=$(PROG_ARGS) --ppn=$(JOB_PPN) --nodes=$(JOB_NODES) --jobparms="$(parms)"

bgqrun:
	$(BGQ_BUILD_DIR)/bgpm/tests/bgqrun.sh $(block) $(TESTNAME).elf $(BGQRUN_ARGS)


-include .dep.*.d


